<aside class="sidebar">
  <h3>Table of Contents</h3>
  {% assign lessons_by_section = site.lessons | sort: "order" | group_by: "section" %}

  {% for section in lessons_by_section %}
    <h4>Section {{ section.name }}</h4>
    <ul>
      {% assign lessons = section.items | sort: "order" %}
      {% assign grouped = lessons | group_by: "lesson" %}
      
      {% for lesson_group in grouped %}
        {% assign main = lesson_group.items | where: "sublesson", 0 | first %}
        {% if main %}
        <li>
          <a href="{{ main.url | relative_url }}">
            Lesson {{ main.section }}.{{ main.lesson }} – {{ main.title }}
          </a>
          {% assign sub_lessons = lesson_group.items | reject: "sublesson", 0 %}
          {% if sub_lessons.size > 0 %}
          <ul>
            {% for sub in sub_lessons %}
              <li>
                <a href="{{ sub.url | relative_url }}">
                  Lesson {{ sub.section }}.{{ sub.lesson }}.{{ sub.sublesson | split: '.' | last }} – {{ sub.title }}
                </a>
              </li>
            {% endfor %}
          </ul>
          {% endif %}
        </li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endfor %}
</aside>
