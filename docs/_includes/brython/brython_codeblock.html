{% capture starter_code %}
{% if include.starter == "section-0/brython_overview.py" %}
{% include brython/starters/section-0/brython_overview.py %}
{% elsif include.starter == "section-1/hello_world.py" %}
{% include brython/starters/section-1/hello_world.py %}
{% elsif include.starter == "section-2/input_example.py" %}
{% include brython/starters/section-2/input_example.py %}
{% elsif include.starter == "intro/hello_world.py" %}
{% include brython/starters/intro/hello_world.py %}
{% else %}
# Write your Python code here
print("Hello from Brython!")
{% endif %}
{% endcapture %}

<!-- Code editor and output container -->
<div class="brython-wrapper" style="margin-bottom: 2em;">
  <textarea id="code{{ include.id }}" style="width:100%;height:150px;" onkeydown="handleTab(event)">
{{ starter_code }}
  </textarea>
  <button onclick="runBrython('{{ include.id }}')">Run</button>
  <pre id="output{{ include.id }}" style="background:#111;color:#0f0;padding:1em;"></pre>
</div>

<!-- Redirect print() and errors to the output box -->
<script type="text/python">
from browser import document
import sys

class OutputCatcher:
    def __init__(self, id):
        self.output = document[f"output{id}"]
    def write(self, data):
        self.output.text += str(data)
    def flush(self):
        pass  # Needed for compatibility

# Call this before running user code to bind stdout/stderr
def setup_output(id):
    catcher = OutputCatcher(id)
    sys.stdout = catcher
    sys.stderr = catcher
</script>

<!-- JavaScript for tab indentation and running Brython code -->
<script>
function handleTab(e) {
  if (e.key === "Tab") {
    e.preventDefault();
    const textarea = e.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const tab = "    ";
    textarea.value = textarea.value.substring(0, start) + tab + textarea.value.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + tab.length;
  }
}

function runBrython(id) {
  const textarea = document.getElementById("code" + id);
  const output = document.getElementById("output" + id);
  output.textContent = "";

  // Remove any existing user script
  const scriptId = `user_script_${id}`;
  let existingScript = document.getElementById(scriptId);
  if (existingScript) existingScript.remove();

  // Insert setup script to capture print() output
  const setupOutputScript = document.createElement("script");
  setupOutputScript.type = "text/python";
  setupOutputScript.textContent = `setup_output('${id}')`;
  document.body.appendChild(setupOutputScript);

  // Insert the actual user script
  const script = document.createElement("script");
  script.type = "text/python";
  script.id = scriptId;
  script.textContent = textarea.value;
  document.body.appendChild(script);

  // Re-initialize Brython to run the new scripts
  brython();
}
</script>
