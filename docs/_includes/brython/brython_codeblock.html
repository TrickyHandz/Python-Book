{% capture starter_code %}
{% if include.starter == "section-0/brython_overview.py" %}
{% include brython/starters/section-0/brython_overview.py %}
{% elsif include.starter == "section-1/hello_world.py" %}
{% include brython/starters/section-1/hello_world.py %}
{% elsif include.starter == "section-2/input_example.py" %}
{% include brython/starters/section-2/input_example.py %}
{% elsif include.starter == "intro/hello_world.py" %}
{% include brython/starters/intro/hello_world.py %}
{% else %}
# Write your Python code here
print("Hello from Brython!")
{% endif %}
{% endcapture %}

<!-- Code editor and output container -->
<div class="brython-wrapper" style="margin-bottom: 2em;">
  <textarea id="code{{ include.id }}" style="width:100%;height:150px;" onkeydown="handleTab(event)">
{{ starter_code }}
  </textarea>
  <button onclick="runBrython('{{ include.id }}')">Run</button>
  <pre id="output{{ include.id }}" style="background:#111;color:#0f0;padding:1em;min-height:1.5em;"></pre>
</div>

<!-- Python: Redirect print() and errors to the output box -->
<script type="text/python">
from browser import document
import sys

class OutputCatcher:
    def __init__(self, id):
        self.output = document[f"output{id}"]
    def write(self, data):
        self.output.text += str(data)
    def flush(self):
        pass  # Needed for compatibility

# Sets up sys.stdout and sys.stderr redirection
def setup_output(id):
    catcher = OutputCatcher(id)
    sys.stdout = catcher
    sys.stderr = catcher
</script>

<!-- JavaScript for handling tab indent and running Brython code -->
<script>
function handleTab(e) {
  if (e.key === "Tab") {
    e.preventDefault();
    const textarea = e.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const tab = "    ";
    textarea.value = textarea.value.substring(0, start) + tab + textarea.value.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + tab.length;
  }
}

function runBrython(id) {
  const textarea = document.getElementById("code" + id);
  const output = document.getElementById("output" + id);
  output.textContent = "";

  // Remove old scripts if they exist
  const scriptId = `user_script_${id}`;
  const setupId = `setup_script_${id}`;
  let oldScript = document.getElementById(scriptId);
  let oldSetup = document.getElementById(setupId);
  if (oldScript) oldScript.remove();
  if (oldSetup) oldSetup.remove();

  // Add setup script to redirect output
  const setupScript = document.createElement("script");
  setupScript.type = "text/python";
  setupScript.id = setupId;
  setupScript.textContent = `setup_output('${id}')`;
  document.body.appendChild(setupScript);

  // Add user's Brython code as a new <script> element
  const userScript = document.createElement("script");
  userScript.type = "text/python";
  userScript.id = scriptId;
  userScript.textContent = textarea.value;
  document.body.appendChild(userScript);

  // Slight delay to let DOM update before Brython runs
  setTimeout(() => brython(), 50);
}
</script>
